<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSA JAMB PRACTICE APP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary-blue: #2e3075; --dark-bg: #0f111a; --card-bg: #1e1f2b; }
        body { background-color: var(--dark-bg); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; }
        .app-container { min-height: 100vh; padding-bottom: 80px; }
        .app-section { display: none; padding: 20px; animation: fadeIn 0.3s ease-in; }
        #dashboard-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Header & Cards */
        .header-box { padding: 30px 20px; background-color: var(--primary-blue); border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; margin-bottom: 20px; }
        .subject-scroll { display: flex; gap: 12px; overflow-x: auto; scrollbar-width: none; padding-bottom: 10px; }
        .mini-card { min-width: 140px; padding: 15px; background: #161722; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .quick-card { height: 110px; border-radius: 15px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; border: none; transition: transform 0.2s; }
        .quick-card:active { transform: scale(0.95); }

        /* Exam Hall Styles */
        .progress { height: 6px; background: #161722; border-radius: 10px; margin-bottom: 15px; }
        .passage-box { background: #252736; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #0d6efd; font-size: 0.9rem; max-height: 250px; overflow-y: auto; color: #cfd1d8; }
        .question-box { background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .option-btn { background: #161722; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 12px; width: 100%; text-align: left; color: white; transition: 0.2s; }
        .option-btn.active { border-color: #0d6efd; background: rgba(13, 110, 253, 0.15); box-shadow: 0 0 10px rgba(13,110,253,0.3); }
        .option-btn.correct { background: rgba(25, 135, 84, 0.3) !important; border-color: #198754 !important; }
        .option-btn.wrong { background: rgba(220, 53, 69, 0.3) !important; border-color: #dc3545 !important; }

        /* Navigation */
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: var(--primary-blue); display: flex; justify-content: space-around; padding: 12px 0; border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1000; }
        .nav-link { color: rgba(255,255,255,0.5); text-decoration: none; font-size: 0.7rem; text-align: center; cursor: pointer; }
        .nav-link.active { color: white; }
        
        /* Gradients */
        .bg-purple { background: linear-gradient(135deg, #6259a8, #4c4485); }
        .bg-orange { background: linear-gradient(135deg, #bc743c, #9e5d2d); }
        .bg-teal { background: linear-gradient(135deg, #1d9086, #146e66); }
        .bg-grey { background: linear-gradient(135deg, #5b757b, #465a5f); }
    </style>
</head>
<body>

<div class="app-container">
    <div id="dashboard-view" class="app-section">
        <div class="header-box">
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-primary p-3"><i class="fas fa-user"></i></div>
                <div><h5 class="mb-0 fw-bold">JAMB Candidate</h5><small class="opacity-75">Ready to excel?</small></div>
            </div>
        </div>
        <div class="px-2">
            <h6 class="fw-bold mb-3 px-2"><i class="fas fa-book-open text-warning me-2"></i>Available Subjects</h6>
            <div id="horizontal-list" class="subject-scroll"></div>
            
            <h6 class="fw-bold mt-4 mb-3 px-2"><i class="fas fa-rocket text-info me-2"></i>Quick Menu</h6>
            <div class="grid-container">
                <div class="quick-card bg-purple" onclick="showSection('practice-view')"><i class="fas fa-desktop fs-4"></i><span>Practice CBT</span></div>
                <div class="quick-card bg-orange"><i class="fas fa-file-signature fs-4"></i><span>Mock Exam</span></div>
                <div class="quick-card bg-teal"><i class="fas fa-history fs-4"></i><span>History</span></div>
                <div class="quick-card bg-grey"><i class="fas fa-cog fs-4"></i><span>Settings</span></div>
            </div>
        </div>
    </div>

    <div id="practice-view" class="app-section">
        <div class="d-flex align-items-center mb-4">
            <button class="btn text-white me-2" onclick="showSection('dashboard-view')"><i class="fas fa-chevron-left"></i></button>
            <h4 class="mb-0 fw-bold">Select Subject</h4>
        </div>
        <div id="practice-subject-grid" class="grid-container"></div>
    </div>

    <div id="exam-hall-view" class="app-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 id="exam-subject-title" class="fw-bold text-info mb-0">Subject</h6>
            <div class="badge bg-danger fs-6" id="exam-timer">02:00:00</div>
        </div>
        
        <div class="progress">
            <div id="exam-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
        </div>

        <div id="passage-container" class="passage-box" style="display:none;"></div>
        
        <div class="question-box">
            <div class="d-flex justify-content-between mb-2">
                <span class="badge bg-dark" id="q-counter">Q1</span>
                <i class="fas fa-calculator text-secondary" style="cursor:pointer;" onclick="alert('Calculator feature coming soon!')"></i>
            </div>
            <p id="question-text" class="mb-0" style="line-height: 1.6;">Loading question...</p>
        </div>

        <div id="options-container">
            <button class="option-btn" onclick="handleOptionSelection(0)">A. <span class="opt-text"></span></button>
            <button class="option-btn" onclick="handleOptionSelection(1)">B. <span class="opt-text"></span></button>
            <button class="option-btn" onclick="handleOptionSelection(2)">C. <span class="opt-text"></span></button>
            <button class="option-btn" onclick="handleOptionSelection(3)">D. <span class="opt-text"></span></button>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-light px-4" onclick="prevQuestion()"><i class="fas fa-arrow-left me-2"></i>Prev</button>
            <button class="btn btn-success px-4 fw-bold" id="submit-btn" onclick="submitExam()">Submit</button>
            <button class="btn btn-outline-light px-4" onclick="nextQuestion()">Next<i class="fas fa-arrow-right ms-2"></i></button>
        </div>
    </div>

    <div id="result-view" class="app-section text-center">
        <div id="pdf-content" class="py-4 rounded shadow">
            <i class="fas fa-award text-warning" style="font-size: 5rem;"></i>
            <h2 class="mt-3 fw-bold">Exam Finished!</h2>
            <h4 id="result-subject-name" class="text-info">Subject</h4>
            <div class="display-2 fw-bold my-3" id="final-score" style="color:#0d6efd">0 / 0</div>
            <p id="result-message" class="px-4 opacity-75"></p>
        </div>
        <div class="d-grid gap-2 mt-4 px-3">
            <button class="btn btn-primary btn-lg rounded-pill" onclick="startReview()">Review Corrections</button>
            <button class="btn btn-outline-info rounded-pill" onclick="downloadPDF()">Download Result</button>
            <button class="btn btn-outline-light rounded-pill" onclick="location.reload()">Back to Home</button>
        </div>
    </div>

    <div class="nav-bottom">
        <a class="nav-link active" onclick="showSection('dashboard-view')"><i class="fas fa-home d-block fs-5 mb-1"></i>Home</a>
        <a class="nav-link"><i class="fas fa-chart-bar d-block fs-5 mb-1"></i>Stats</a>
        <a class="nav-link"><i class="fas fa-user-circle d-block fs-5 mb-1"></i>Profile</a>
    </div>
</div>

<script>
    const allSubjects = [
        { id: "English Language", file: "english.json", icon: "fas fa-book", color: "#bc743c" },
        { id: "Mathematics", file: "mathematics.json", icon: "fas fa-calculator", color: "#1d9086" },
        { id: "Physics", file: "physics.json", icon: "fas fa-broadcast-tower", color: "#3b7d4f" },
        { id: "Chemistry", file: "chemistry.json", icon: "fas fa-flask", color: "#bc743c" },
        { id: "Biology", file: "biology.json", icon: "fas fa-lungs", color: "#bc743c" },
        { id: "Government", file: "government.json", icon: "fas fa-landmark", color: "#8a2be2" }
    ];

    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let timerInterval = null;
    let timeLeft = 120 * 60; 
    let userSelections = {}; 
    let isReviewMode = false;
    let activePassage = "";
    let lastActiveSubject = "";

    function showSection(id) {
        document.querySelectorAll('.app-section').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if(id === 'practice-view') renderPracticeGrid();
        window.scrollTo(0,0);
    }

    function renderPracticeGrid() {
        const grid = document.getElementById('practice-subject-grid');
        grid.innerHTML = allSubjects.map(s => `
            <div class="mini-card text-center" style="cursor:pointer; border-bottom: 3px solid ${s.color}" onclick="startExam('${s.id}')">
                <i class="${s.icon} mb-2 fs-3" style="color:${s.color}"></i>
                <div style="font-size:0.8rem; font-weight:600">${s.id}</div>
            </div>`).join('');
    }

    async function startExam(subjectId) {
        lastActiveSubject = subjectId;
        const subj = allSubjects.find(s => s.id === subjectId);
        showSection('exam-hall-view');
        
        try {
            const res = await fetch(subj.file + '?v=' + Date.now());
            const data = await res.json();
            
            // Critical Fix: Handle different JSON formats (some use .q, some .question)
            currentQuestions = data.filter(item => item.q || item.question);
            activePassage = data.find(item => item.p || item.passage)?.p || "";
            
            if(currentQuestions.length > 0) {
                currentQuestionIndex = 0;
                userSelections = {};
                isReviewMode = false;
                document.getElementById('exam-subject-title').innerText = subjectId;
                document.getElementById('submit-btn').innerHTML = "Submit";
                loadQuestion();
                startTimer();
            } else {
                throw new Error("No questions found");
            }
        } catch(e) {
            alert("Error loading " + subjectId + ". Ensure the JSON file exists on your server.");
            showSection('dashboard-view');
        }
    }

    function startTimer() {
        clearInterval(timerInterval);
        timeLeft = 120 * 60;
        timerInterval = setInterval(() => {
            timeLeft--;
            let h = Math.floor(timeLeft / 3600);
            let m = Math.floor((timeLeft % 3600) / 60);
            let s = timeLeft % 60;
            document.getElementById('exam-timer').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if(timeLeft <= 0) { clearInterval(timerInterval); submitExam(true); }
        }, 1000);
    }

    function loadQuestion() {
        const qData = currentQuestions[currentQuestionIndex];
        const pCont = document.getElementById('passage-container');
        
        // Show passage only if it exists and for first 10 questions (standard JAMB style)
        if(activePassage && currentQuestionIndex < 10) {
            pCont.innerHTML = `<strong>Passage:</strong><br><small>${activePassage}</small>`;
            pCont.style.display = "block";
        } else {
            pCont.style.display = "none";
        }

        // Handle inconsistent JSON keys (q vs question)
        document.getElementById('question-text').innerHTML = qData.q || qData.question;
        document.getElementById('q-counter').innerText = `Question ${currentQuestionIndex + 1}/${currentQuestions.length}`;
        
        // Progress bar
        const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
        document.getElementById('exam-progress').style.width = progress + '%';

        const btns = document.querySelectorAll('.option-btn');
        const optsTexts = document.querySelectorAll('.opt-text');
        const letters = ['a', 'b', 'c', 'd'];

        btns.forEach((btn, i) => {
            btn.className = "option-btn";
            const optValue = qData.options ? qData.options[i] : (qData['option' + letters[i].toUpperCase()] || "");
            optsTexts[i].innerText = optValue;

            if(!isReviewMode && userSelections[currentQuestionIndex] === letters[i]) {
                btn.classList.add('active');
            }

            if(isReviewMode) {
                const correct = (qData.answer || qData.a || "").toLowerCase().trim();
                const userChoice = userSelections[currentQuestionIndex];
                if(letters[i] === correct) btn.classList.add('correct');
                if(userChoice === letters[i] && userChoice !== correct) btn.classList.add('wrong');
            }
        });
    }

    function handleOptionSelection(idx) {
        if(isReviewMode) return;
        const letters = ['a', 'b', 'c', 'd'];
        userSelections[currentQuestionIndex] = letters[idx];
        loadQuestion();
    }

    function nextQuestion() { if(currentQuestionIndex < currentQuestions.length - 1) { currentQuestionIndex++; loadQuestion(); } }
    function prevQuestion() { if(currentQuestionIndex > 0) { currentQuestionIndex--; loadQuestion(); } }

    function submitExam(auto = false) {
        if(!auto && !confirm("Finish and see your result?")) return;
        clearInterval(timerInterval);
        
        let score = 0;
        currentQuestions.forEach((q, i) => {
            const correct = (q.answer || q.a || "").toLowerCase().trim();
            if(userSelections[i] === correct) score++;
        });

        document.getElementById('final-score').innerText = `${score} / ${currentQuestions.length}`;
        document.getElementById('result-subject-name').innerText = lastActiveSubject;
        
        const percent = (score / currentQuestions.length) * 100;
        document.getElementById('result-message').innerText = percent >= 50 ? "Great job! Keep practicing to reach 100%." : "Don't give up. Review your corrections and try again.";
        
        showSection('result-view');
    }

    function startReview() {
        isReviewMode = true;
        currentQuestionIndex = 0;
        document.getElementById('submit-btn').innerHTML = "<i class='fas fa-home'></i> Home";
        document.getElementById('submit-btn').onclick = () => location.reload();
        showSection('exam-hall-view');
        loadQuestion();
    }

    function downloadPDF() {
        const element = document.getElementById('pdf-content');
        html2pdf().from(element).save(`${lastActiveSubject}_Score.pdf`);
    }

    // Init dashboard
    window.onload = () => {
        const list = document.getElementById('horizontal-list');
        list.innerHTML = allSubjects.map(s => `
            <div class="mini-card d-flex align-items-center gap-2">
                <i class="${s.icon}" style="color:${s.color}"></i>
                <span style="font-size:0.7rem; white-space:nowrap">${s.id}</span>
            </div>`).join('');
    };
</script>
</body>
</html>
