<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSA JAMB PRO v5.1 - Fixed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --jamb-blue: #0d47a1; --accent: #ffd600; --bg: #f4f7f6; --success: #28a745; }
        body { background: linear-gradient(135deg, var(--bg), #e8f4fd); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        .header { background: linear-gradient(135deg, var(--jamb-blue), #1976d2); color: white; padding: 12px; border-bottom: 4px solid var(--accent); position: sticky; top: 0; z-index: 1050; }
        
        .subject-card { background: white; border-radius: 16px; padding: 20px; cursor: pointer; border: 2px solid transparent; text-align: center; transition: all 0.3s; box-shadow: 0 6px 20px rgba(0,0,0,0.1); height: 100%; position: relative; overflow: hidden; }
        .subject-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--jamb-blue); transform: scaleX(0); transition: 0.3s; }
        .subject-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
        .subject-card.selected { border-color: var(--success); background: linear-gradient(135deg, #f0fff4, white); }
        .subject-card.selected::before { transform: scaleX(1); background: var(--success); }

        .subject-tabs { background: white; border-bottom: 3px solid #eee; position: sticky; top: 55px; z-index: 1000; display: flex; overflow-x: auto; scrollbar-width: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tab-item { flex: 1; text-align: center; padding: 15px 10px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #666; min-width: 100px; white-space: nowrap; transition: 0.3s; }
        .tab-item.active { border-bottom-color: var(--jamb-blue); color: var(--jamb-blue); background: linear-gradient(135deg, #eef2f7, white); }

        .progress-bar-container { background: #e9ecef; height: 8px; border-radius: 4px; margin-bottom: 15px; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--success), #20c997); transition: width 0.5s; border-radius: 4px; }

        .question-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .option { display: block; width: 100%; padding: 15px; margin-bottom: 10px; border: 2px solid #e9ecef; border-radius: 10px; text-align: left; background: white; transition: all 0.3s; cursor: pointer; font-size: 1rem; }
        .option:hover { border-color: var(--jamb-blue); transform: translateX(5px); box-shadow: 0 4px 12px rgba(13,71,161,0.15); }
        .option.selected { background: linear-gradient(135deg, var(--jamb-blue), #1976d2); color: white; border-color: var(--jamb-blue); transform: scale(1.02); }
        .option.review { background: #fff3cd !important; border-color: #ffc107 !important; }
        .passage-box { background: linear-gradient(135deg, #fffbe6, #fff2cc); border-left: 5px solid #ffc107; padding: 20px; margin-bottom: 20px; border-radius: 0 12px 12px 0; font-size: 0.95rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        
        #calc-panel { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: linear-gradient(135deg, #222, #333); color: white; transition: 0.4s; z-index: 2000; padding: 25px; box-shadow: -8px 0 25px rgba(0,0,0,0.4); overflow-y: auto; }
        #calc-panel.open { right: 0; }
        .calc-btn { width: 60px; height: 60px; margin: 5px; font-size: 1.3rem; font-weight: bold; border-radius: 12px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.2s; }
        .calc-btn:active { transform: scale(0.95); }

        .score-circle { width: 160px; height: 160px; border-radius: 50%; border: 12px solid; display: flex; align-items: center; justify-content: center; margin: 25px auto; font-size: 3.5rem; font-weight: 800; color: white; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .score-circle.gold { border-color: #ffd700; background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; }
        .score-circle.green { border-color: var(--success); background: linear-gradient(135deg, var(--success), #20c997); }
        .score-circle.orange { border-color: #fd7e14; background: linear-gradient(135deg, #fd7e14, #ffc107); }
        .score-circle.red { border-color: #dc3545; background: linear-gradient(135deg, #dc3545, #e74c3c); }

        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--jamb-blue); color: white; border: none; font-size: 1.5rem; box-shadow: 0 8px 25px rgba(13,71,161,0.4); z-index: 1500; transition: 0.3s; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 12px 35px rgba(13,71,161,0.5); }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .pulse { animation: pulse 2s infinite; }

        @media (max-width: 576px) { .tab-item { min-width: 80px; padding: 12px 5px; font-size: 0.9rem; } }
    </style>
</head>
<body>

<div class="header d-flex justify-content-between align-items-center shadow-lg">
    <div class="fw-bold fs-4"><i class="fas fa-graduation-cap me-2"></i>FSA-JAMB v5.1</div>
    <div id="timer" class="badge bg-dark fs-5 px-3 py-2 shadow">02:00:00</div>
    <div>
        <button class="btn btn-sm btn-warning me-1 fw-bold" onclick="toggleCalc()"><i class="fas fa-calculator"></i></button>
        <button class="btn btn-sm btn-info fw-bold me-1" onclick="toggleReview()" id="review-btn"><i class="fas fa-flag" id="review-icon"></i></button>
    </div>
</div>

<div id="calc-panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Calculator</h5>
        <button class="btn btn-sm btn-outline-light" onclick="toggleCalc()">âœ•</button>
    </div>
    <input type="text" id="calc-display" class="form-control mb-4 text-end fs-3 fw-bold" readonly style="background: #444; color: #fff; border: 2px solid #555; border-radius: 8px;">
    <div class="row g-2 justify-content-center">
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('7')">7</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('8')">8</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('9')">9</button></div>
        <div class="col-3"><button class="btn btn-danger calc-btn w-100" onclick="calcInput('C')">C</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('4')">4</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('5')">5</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('6')">6</button></div>
        <div class="col-3"><button class="btn btn-warning calc-btn w-100" onclick="calcInput('*')">Ã—</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('1')">1</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('2')">2</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('3')">3</button></div>
        <div class="col-3"><button class="btn btn-warning calc-btn w-100" onclick="calcInput('-')">-</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('0')">0</button></div>
        <div class="col-3"><button class="btn btn-secondary calc-btn w-100" onclick="calcInput('.')">.</button></div>
        <div class="col-3"><button class="btn btn-warning calc-btn w-100" onclick="calcInput('/')">Ã·</button></div>
        <div class="col-3"><button class="btn btn-warning calc-btn w-100" onclick="calcInput('+')">+</button></div>
        <div class="col-6"><button class="btn btn-success calc-btn w-100 fs-5" onclick="calcInput('=')">=</button></div>
    </div>
</div>

<div class="container mt-5">
    <div id="setup-screen">
        <div class="text-center mb-5">
            <h2 class="fw-bold text-primary mb-3"><i class="fas fa-rocket me-2"></i>Student Dashboard</h2>
            <p class="lead text-muted">Select English + 3 Subjects for JAMB UTME Practice</p>
            <small class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i>Offline â€¢ Timed â€¢ Realistic CBT</small>
        </div>
        <div class="row g-4 mb-5" id="subject-grid"></div>
        <div class="text-center">
            <button id="start-btn" class="btn btn-primary btn-lg w-100 py-4 fw-bold shadow-lg disabled pulse" style="border-radius: 25px; font-size: 1.3rem;" onclick="beginExam()">
                <i class="fas fa-play-circle me-2"></i>START EXAMINATION
            </button>
            <div id="selection-count" class="mt-3 text-muted"></div>
        </div>
    </div>

    <div id="exam-screen" style="display:none;">
        <div class="subject-tabs mb-4" id="tab-container"></div>
        <div class="question-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 id="current-sub-label" class="text-primary fw-bold mb-0"><i class="fas fa-book me-2"></i></h5>
                <div>
                    <span id="q-count" class="badge bg-secondary fs-6 px-3 py-2 me-2 shadow-sm"></span>
                    <div class="progress-bar-container" style="width: 150px; display: inline-block;">
                        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div id="q-container"></div>
            <div class="d-flex justify-content-between mt-5">
                <button class="btn btn-outline-secondary px-5 py-3 fw-bold shadow-sm" onclick="moveQ(-1)"><i class="fas fa-chevron-left me-2"></i>PREV</button>
                <span class="align-self-center text-muted fs-6" id="q-nav"></span>
                <button class="btn btn-primary px-5 py-3 fw-bold shadow-sm" onclick="moveQ(1)">NEXT<i class="fas fa-chevron-right ms-2"></i></button>
            </div>
        </div>
        <button class="btn btn-success w-100 mt-5 p-4 fw-bold shadow-lg pulse" style="border-radius: 25px; font-size: 1.2rem;" onclick="finish()">
            <i class="fas fa-flag-checkered me-2"></i>SUBMIT FINISHED EXAM
        </button>
    </div>

    <div id="result-screen" style="display:none;">
        <div class="card border-0 shadow-xl p-5 text-center mx-auto" style="max-width: 600px;">
            <h4 class="text-muted mb-4"><i class="fas fa-trophy me-2"></i>YOUR RESULTS</h4>
            <div class="score-circle gold" id="total-score">0</div>
            <h3 id="status-msg" class="mt-4 mb-5 fw-bold"></h3>
            <div id="breakdown" class="text-start border-top pt-4 mb-5"></div>
            <div class="row g-3">
                <div class="col-6"><button class="btn btn-outline-primary w-100 py-3 fw-bold" onclick="reviewMode()"><i class="fas fa-redo me-2"></i>REVIEW EXAM</button></div>
                <div class="col-6"><button class="btn btn-primary w-100 py-3 fw-bold" onclick="location.reload()"><i class="fas fa-play-circle me-2"></i>RETAKE EXAM</button></div>
            </div>
        </div>
    </div>
</div>

<button class="fab" onclick="toggleHelp()" title="Help & Tips"><i class="fas fa-question-circle"></i></button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const allSubs = [
        {id:"English", icon:"ðŸ“š", required: true}, {id:"Mathematics", icon:"ðŸ“"}, {id:"Physics", icon:"âš›ï¸"}, 
        {id:"Chemistry", icon:"ðŸ§ª"}, {id:"Biology", icon:"ðŸ§¬"}, {id:"Government", icon:"ðŸ›ï¸"}, 
        {id:"Crk", icon:"ðŸ“–"}, {id:"Economics", icon:"ðŸ“ˆ"}, {id:"Commerce", icon:"ðŸ›’"}, {id:"Accounting", icon:"ðŸ’¼"}
    ];
    let selected = ["English"], examData = {}, activeSub = "English", activeIdx = 0, userAns = {}, 
        reviewMode = false, timerInterval, timeLeft = 7200, flagged = {};

    function init() {
        const grid = document.getElementById('subject-grid');
        grid.innerHTML = allSubs.map(s => `
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
                <div class="subject-card ${selected.includes(s.id)?'selected':''}" onclick="toggle('${s.id}')">
                    <div class="fs-1 mb-3">${s.icon}</div>
                    <div class="h5 fw-bold mb-1">${s.id}</div>
                    ${s.required ? '<small class="badge bg-success">Required</small>' : ''}
                </div>
            </div>`).join('');
        const count = selected.length;
        document.getElementById('start-btn').classList.toggle('disabled', count < 4);
        document.getElementById('selection-count').innerText = `${count}/4 subjects selected`;
    }

    function toggle(id) {
        if (allSubs.find(s => s.id === id)?.required) return;
        const i = selected.indexOf(id);
        if (i > -1) selected.splice(i, 1); 
        else if (selected.length < 4) selected.push(id);
        init();
    }

    async function beginExam() {
        if (selected.length < 4) return alert('Select 4 subjects!');
        const btn = document.getElementById('start-btn');
        btn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> Loading Questions...`;
        btn.disabled = true;
        examData = {}; userAns = {}; flagged = {};
        for (let s of selected) {
            try {
                const res = await fetch(`${s.toLowerCase()}.json?v=${Date.now()}`);
                if (!res.ok) throw new Error('Not found');
                examData[s] = await res.json();
                userAns[s] = new Array(examData[s].length).fill(null);
                flagged[s] = new Array(examData[s].length).fill(false);
            } catch(e) { 
                alert(`Error: ${s.toLowerCase()}.json not found! Create it with 50+ JAMB questions.`);
                btn.innerHTML = '<i class="fas fa-play-circle me-2"></i>START EXAMINATION';
                btn.disabled = false;
                btn.classList.add('pulse');
                return; 
            }
        }
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
        document.getElementById('tab-container').innerHTML = selected.map((s, i) => 
            `<div class="tab-item ${i===0?'active':''}" id="tab-${s}" onclick="switchTab('${s}')"><i class="fas fa-book me-1"></i>${s}</div>`).join('');
        switchTab("English");
        startTimer(7200);
        btn.innerHTML = '<i class="fas fa-play-circle me-2"></i>START EXAMINATION';
        btn.disabled = false;
        btn.classList.remove('pulse');
    }

    function switchTab(sName) {
        activeSub = sName; activeIdx = 0;
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${sName}`).classList.add('active');
        render();
    }

    function render() {
        const questions = examData[activeSub];
        const q = questions[activeIdx];
        const answered = userAns[activeSub][activeIdx] !== null;
        const progress = ((activeIdx + 1) / questions.length) * 100;
        
        document.getElementById('current-sub-label').innerHTML = `<i class="fas fa-${getIcon(activeSub)} me-2"></i>${activeSub}`;
        document.getElementById('q-count').innerHTML = `${activeIdx + 1}/${questions.length} <small class="text-muted">${answered ? 'âœ“' : 'â—‹'}</small>`;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('q-nav').innerText = `${activeSub} Q${activeIdx+1}`;
        
        let html = '';
        if (q.p) html += `<div class="passage-box"><strong>Passage:</strong> ${q.p}</div>`;
        html += `<div class="mb-4 fs-4 fw-semibold">${q.q}</div>`;
        q.options.forEach((opt, i) => {
            const isSelected = userAns[activeSub][activeIdx] === i;
            const isFlagged = flagged[activeSub][activeIdx];
            const cls = isSelected ? 'selected' : (isFlagged ? 'review' : '');
            html += `<button class="option ${cls}" onclick="pick(${i})">
                <strong>${String.fromCharCode(65+i)}.</strong> ${opt}
                ${isFlagged ? '<i class="fas fa-flag float-end text-warning"></i>' : ''}
            </button>`;
        });
        document.getElementById('q-container').innerHTML = html;
    }

    function pick(i) { 
        userAns[activeSub][activeIdx] = i; 
        render(); 
    }

    function moveQ(d) { 
        const newIdx = activeIdx + d;
        if (newIdx >= 0 && newIdx < examData[activeSub].length) { 
            activeIdx = newIdx; 
            render(); 
        } 
    }

    function toggleReview() {
        const firstUnanswered = [];
        for (let i = 0; i < examData[activeSub].length; i++) {
            if (userAns[activeSub][i] === null || flagged[activeSub][i]) {
                firstUnanswered.push(i);
            }
        }
        if (firstUnanswered.length > 0) {
            activeIdx = firstUnanswered[0];
            render();
        } else {
            alert('All questions answered!');
        }
    }

    function finish() {
        if (!confirm("Submit exam? Answers can't be changed!")) return;
        clearInterval(timerInterval);
        let grandTotal = 0, report = '', statusClass = 'orange';
        selected.forEach(s => {
            let score = 0, subQs = examData[s].length;
            examData[s].forEach((q, i) => { if (userAns[s][i] === q.a) score++; });
            const p = Math.round((score / subQs) * 100);
            grandTotal += p;
            const subStatus = p >= 80 ? 'gold' : p >= 60 ? 'green' : 'orange';
            report += `
                <div class="row align-items-center mb-4 p-3 rounded shadow-sm bg-light">
                    <div class="col-8"><i class="fas fa-${getIcon(s)} text-primary me-2"></i><strong>${s}</strong></div>
                    <div class="col-4 text-end">
                        <div class="h5 fw-bold text-${subStatus === 'gold' ? 'warning' : subStatus}">${score}/${subQs}</div>
                        <small class="text-muted">${p}%</small>
                    </div>
                </div>`;
        });
        grandTotal = Math.round(grandTotal / selected.length);
        document.getElementById('total-score').innerText = grandTotal;
        document.getElementById('total-score').className = `score-circle ${grandTotal >= 280 ? 'gold' : grandTotal >= 220 ? 'green' : grandTotal >= 180 ? 'orange' : 'red'}`;
        
        let msg = grandTotal >= 280 ? "ðŸ† Medicine/Law Unlocked! Elite Score!" : 
                  grandTotal >= 220 ? "âœ… Competitive Score! Top Universities!" : 
                  grandTotal >= 180 ? "ðŸ“ˆ Good Effort! More Practice Needed" : "ðŸ’ª Keep Practicing! You're Getting There!";
        document.getElementById('status-msg').innerHTML = msg;
        document.getElementById('breakdown').innerHTML = report;

        document.getElementById('exam-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
    }

    function reviewMode() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'block';
    }

    function startTimer(t) {
        timeLeft = t;
        timerInterval = setInterval(() => {
            if (timeLeft <= 0) {
